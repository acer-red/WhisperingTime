syntax = "proto3";

package whisperingtime;

option go_package = "github.com/tengfei-xy/whisperingtime/engine/grpc/pb";
option java_multiple_files = true;
option java_package = "dev.whisperingtime.grpc";

message BasicResponse {
  int32 err = 1;
  string msg = 2;
}

message Empty {}

// Theme models
message ThemeSummary {
  string id = 1;
  bytes name = 2;
}

message PermissionEnvelope {
  bytes encrypted_key = 1;
  string role = 2;
}

message GroupConfig {
  repeated bool levels = 3;
  int32 view_type = 4;
  int32 sort_type = 5;
  int32 auto_freeze_days = 6;
}

message DocConfig {
  bool is_show_tool = 1;
  int32 display_priority = 2;
}

message GroupSummary {
  string id = 1;
  bytes name = 2;
  int64 create_at = 3;
  int64 update_at = 4;
  int64 over_at = 5;
  GroupConfig config = 6;
  PermissionEnvelope permission = 7;
}

message DocSummary {
  string id = 1;
  Content content = 2;
  reserved 4;
  int64 create_at = 5;
  int64 update_at = 6;
  PermissionEnvelope permission = 7;
  DocConfig config = 8;
}

message Content {
  optional bytes title = 1;
  optional bytes rich = 2;
  optional bytes level = 3;
  optional bytes scales = 4;
}

message DocDetail {
  string id = 1;
  Content content = 2;
  reserved 5;
  int64 create_at = 6;
  int64 update_at = 7;
  PermissionEnvelope permission = 8;
  DocConfig config = 9;
}

message GroupDetail {
  string id = 1;
  bytes name = 2;
  GroupConfig config = 3;
  repeated DocDetail docs = 4;
  PermissionEnvelope permission = 5;
}

message ThemeDetail {
  string id = 1;
  bytes name = 2;
  repeated GroupDetail groups = 3;
  PermissionEnvelope permission = 4;
}

// Theme service
message ListThemesRequest {
  bool include_docs = 1;   // if true, include doc list per group (summary)
  bool include_detail = 2; // if true, include full doc detail per group
}

message ListThemesResponse {
  int32 err = 1;
  string msg = 2;
  repeated ThemeDetail themes = 3;
}

message CreateThemeRequest {
  bytes name = 1;
  bytes default_group_name = 2;
  bytes encrypted_key = 3;
  bytes default_group_encrypted_key = 4;
}
message CreateThemeResponse { int32 err = 1; string msg = 2; string id = 3; }
message UpdateThemeRequest {
  string id = 1;
  bytes name = 2;
  bytes encrypted_key = 3;
}
message DeleteThemeRequest { string id = 1; }
message ExportAllConfigRequest {}
message DeleteUserDataRequest {}

service ThemeService {
  rpc ListThemes(ListThemesRequest) returns (ListThemesResponse);
  rpc CreateTheme(CreateThemeRequest) returns (CreateThemeResponse);
  rpc UpdateTheme(UpdateThemeRequest) returns (BasicResponse);
  rpc DeleteTheme(DeleteThemeRequest) returns (BasicResponse);
  rpc ExportAllConfig(ExportAllConfigRequest) returns (BasicResponse);
  rpc DeleteUserData(DeleteUserDataRequest) returns (BasicResponse);
}

// Group service
message ListGroupsRequest { string theme_id = 1; }
message ListGroupsResponse { int32 err = 1; string msg = 2; repeated GroupSummary groups = 3; }

message GetGroupRequest { string theme_id = 1; string group_id = 2; bool include_docs = 3; bool include_detail = 4; }
message GetGroupResponse { int32 err = 1; string msg = 2; GroupDetail group = 3; }

message CreateGroupRequest {
  string theme_id = 1;
  bytes name = 2;
  int32 auto_freeze_days = 3;
  bytes encrypted_key = 4;
}
message CreateGroupResponse { int32 err = 1; string msg = 2; string id = 3; }
message UpdateGroupRequest {
  string theme_id = 1;
  string group_id = 2;
  bytes name = 3;
  GroupConfig config = 4;
  int64 over_at = 5;
  bytes encrypted_key = 6;
}
message DeleteGroupRequest { string theme_id = 1; string group_id = 2; }
message ExportGroupConfigRequest { string theme_id = 1; string group_id = 2; }
message ImportGroupConfigResponse { int32 err = 1; string msg = 2; }

service GroupService {
  rpc ListGroups(ListGroupsRequest) returns (ListGroupsResponse);
  rpc GetGroup(GetGroupRequest) returns (GetGroupResponse);
  rpc CreateGroup(CreateGroupRequest) returns (CreateGroupResponse);
  rpc UpdateGroup(UpdateGroupRequest) returns (BasicResponse);
  rpc DeleteGroup(DeleteGroupRequest) returns (BasicResponse);
  rpc ExportGroupConfig(ExportGroupConfigRequest) returns (BasicResponse);
  // Client streaming upload of config zip
  rpc ImportGroupConfig(stream BytesChunk) returns (ImportGroupConfigResponse);
}

// Doc service
message ListDocsRequest { string group_id = 1; int32 year = 2; int32 month = 3; }
message ListDocsResponse { int32 err = 1; string msg = 2; repeated DocSummary docs = 3; }
message CreateDocRequest {
  string group_id = 1;
  Content content = 2;
  reserved 5;
  int64 create_at = 6;
  bytes encrypted_key = 7;
  DocConfig config = 8;
}
message CreateDocResponse { int32 err = 1; string msg = 2; string id = 3; }
message UpdateDocRequest {
  string group_id = 1;
  string doc_id = 2;
  Content content = 3;
  reserved 6;
  int64 create_at = 7;
  bytes encrypted_key = 8;
  DocConfig config = 9;
}
message DeleteDocRequest { string group_id = 1; string doc_id = 2; }

service DocService {
  rpc ListDocs(ListDocsRequest) returns (ListDocsResponse);
  rpc CreateDoc(CreateDocRequest) returns (CreateDocResponse);
  rpc UpdateDoc(UpdateDocRequest) returns (BasicResponse);
  rpc DeleteDoc(DeleteDocRequest) returns (BasicResponse);
}

// Image service
message UploadImageResponse { int32 err = 1; string msg = 2; string name = 3; string url = 4; }
message DeleteImageRequest { string name = 1; }

service ImageService {
  // Client streaming upload: send BytesChunk with metadata in first chunk header
  rpc UploadImage(stream ImageUploadChunk) returns (UploadImageResponse);
  rpc DeleteImage(DeleteImageRequest) returns (BasicResponse);
}

message ImageUploadChunk {
  string user_id = 1; // uid
  string mime = 2;    // image/png or image/jpeg
  bytes data = 3;
}

// File service for presigned upload/download
message PresignUploadFileRequest {
  string theme_id = 1;
  string group_id = 2;
  string doc_id = 3;
  string filename = 4;
  string mime = 5;
  int64 size = 6; // ciphertext size
  bytes encrypted_key = 7; // envelope-encrypted data key
  bytes iv = 8; // optional IV if caller separates it from ciphertext
  bytes encrypted_metadata = 9; // encrypted custom metadata from client
  int64 expires_in_sec = 10; // optional presign TTL, default server value
}

message PresignUploadFileResponse {
  int32 err = 1;
  string msg = 2;
  string file_id = 3;
  string object_path = 4;
  string upload_url = 5;
  int64 expires_at = 6; // unix seconds
}

message PresignDownloadFileRequest { string file_id = 1; }

message PresignDownloadFileResponse {
  int32 err = 1;
  string msg = 2;
  string file_id = 3;
  string object_path = 4;
  string download_url = 5;
  int64 expires_at = 6; // unix seconds
  string owner_uid = 7;
  string theme_id = 8;
  string group_id = 9;
  string doc_id = 10;
  string mime = 11;
  int64 size = 12;
  bytes encrypted_key = 13;
  bytes iv = 14;
  bytes encrypted_metadata = 15;
}

message DeleteFileRequest { string file_id = 1; }

// Background job service
message BackgroundJob {
  string id = 1;
  string name = 2;
  string job_type = 3;
  string status = 4;
  string created_at = 5;
  string started_at = 6;
  string completed_at = 7;
  int32 priority = 8;
  int32 retry_count = 9;
  string result_json = 10;
  string error_json = 11;
}

message ListBackgroundJobsRequest {}
message ListBackgroundJobsResponse { int32 err = 1; string msg = 2; repeated BackgroundJob jobs = 3; }
message GetBackgroundJobRequest { string id = 1; }
message DeleteBackgroundJobRequest { string id = 1; }
message DownloadBackgroundJobFileRequest { string id = 1; }
message DownloadBackgroundJobFileResponse { int32 err = 1; string msg = 2; bytes data = 3; string filename = 4; }

service BackgroundJobService {
  rpc ListJobs(ListBackgroundJobsRequest) returns (ListBackgroundJobsResponse);
  rpc GetJob(GetBackgroundJobRequest) returns (BackgroundJob);
  rpc DeleteJob(DeleteBackgroundJobRequest) returns (BasicResponse);
  // Per requirement: return bytes (not streaming) for job download
  rpc DownloadJobFile(DownloadBackgroundJobFileRequest) returns (DownloadBackgroundJobFileResponse);
}

service FileService {
  rpc PresignUploadFile(PresignUploadFileRequest) returns (PresignUploadFileResponse);
  rpc PresignDownloadFile(PresignDownloadFileRequest) returns (PresignDownloadFileResponse);
  rpc DeleteFile(DeleteFileRequest) returns (BasicResponse);
}

// Shared chunk message for client streaming uploads
message BytesChunk { bytes data = 1; }

// ------------------------------
// Zero-Knowledge Scale Templates
// ------------------------------

// Stored as encrypted bytes only (server is blind storage).
message ScaleTemplate {
  string id = 1;
  bytes encrypted_metadata = 2;
  int64 created_at = 3;
}

message ListScaleTemplatesRequest {}
message ListScaleTemplatesResponse {
  int32 err = 1;
  string msg = 2;
  repeated ScaleTemplate templates = 3;
}

message CreateScaleTemplateRequest { bytes encrypted_metadata = 1; }
message CreateScaleTemplateResponse {
  int32 err = 1;
  string msg = 2;
  string id = 3;
}

message UpdateScaleTemplateRequest {
  string id = 1;
  bytes encrypted_metadata = 2;
}

message DeleteScaleTemplateRequest { string id = 1; }

// DocContent is defined explicitly for ZKA data-flow documentation.
// In practice it is carried as Content.scales.
message DocContent { bytes scales = 1; }

service ScaleService {
  rpc ListScaleTemplates(ListScaleTemplatesRequest)
      returns (ListScaleTemplatesResponse);
  rpc CreateScaleTemplate(CreateScaleTemplateRequest)
      returns (CreateScaleTemplateResponse);
  rpc UpdateScaleTemplate(UpdateScaleTemplateRequest) returns (BasicResponse);
  rpc DeleteScaleTemplate(DeleteScaleTemplateRequest) returns (BasicResponse);
}
